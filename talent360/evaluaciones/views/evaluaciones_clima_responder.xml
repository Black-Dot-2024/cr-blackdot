<?xml version="1.0" encoding="utf-8"?>
<odoo>
<data>
    <!-- dise単o copiado de las encuestas de odoo -->
    <template id="evaluaciones.dise単o" name="Dise単o de responder a evaluacion clima" inherit_id="web.frontend_layout" primary="True">
        <xpath expr="//div[@id='wrapwrap']" position="before">
            <t t-set="no_livechat" t-value="True"/>
        </xpath>
        <xpath expr="//div[@id='wrapwrap']" position="attributes">
                <attribute name="t-attf-class" add="o_survey_background" separator=" "/>
        </xpath>
        <xpath expr="//head/t[@t-call-assets][last()]" position="after">
            <t t-call-assets="evaluaciones.evaluaciones_assets" lazy_load="True"/>
        </xpath>
        <xpath expr="//header" position="before">
            <t t-set="no_header" t-value="True"/>
            <t t-set="no_footer" t-value="True"/>
        </xpath>
        <xpath expr="//header" position="after">
            <div id="wrap" class="oe_structure oe_empty"/>
        </xpath>
    </template>

    <!-- Main survey template -->
    <template id="evaluaciones_responder" name="Evaluaciones: responder evaluacion clima">
        <t t-call="evaluaciones.dise単o">
            <div class="wrap o_survey_wrap d-flex">
                <div class="container o_survey_form d-flex flex-column mb-5">
                    <t t-call="evaluaciones.evaluacion_header" />
                    <t t-call="evaluaciones.evaluacion_responder_form" />
                </div>
            </div>
        </t>
    </template>

    <template id="evaluacion_header" name="Evaluacion: Encabezado pagina principal">
        <div class="o_survey_nav pt16 mb-2">
            <div class="container m-0 p-0">
                <div class="row">
                    <div  class="col-lg-10">
                        <h1 class="o_survey_main_title pt-4">
                            <span t-field="evaluacion.nombre" />
                        </h1>
                    </div>
                </div>
                <div class="row">
                    <div  class="col-lg-10">
                        <div t-field='evaluacion.descripcion' class="oe_no_empty pb-5 text-break"/>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="evaluacion_responder_form" name="Evaluaciones: contenido principal">
        <form role="form" method="post" t-att-name="evaluacion.id" class="d-flex flex-grow-1 align-items-center">
            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
            <input type="hidden" name="evaluacion_id" t-att-value="evaluacion.id"/>
            <div class="o_survey_error alert alert-danger d-none" role="alert">
                <p>Hubo un error al momento de validar las evaluaciones.</p>
            </div>

            <div class="o_survey_form_content w-100">
                <t t-if="evaluacion.contestada" t-call="evaluaciones.evaluacion_responder_form_done"/>
                <t t-else="" t-call="evaluaciones.preguntas_contenedor"/>
            </div>
        </form>

        <!-- Modal used to display error message, i.c.o. ajax error -->
        <div role="dialog" class="modal fade" id="MasterTabErrorModal" >
            <div class="modal-dialog">
                <div class="modal-content">
                    <header class="modal-header">
                        <h4 class="modal-title">Ha ocurrido un problema</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </header>
                    <main class="modal-body"><p>Para tomar esta evaluacion cierra las demas ventanas<strong class="text-danger"></strong>.</p></main>
                    <footer class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Continua aqui</button></footer>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Start (not taken) survey page -->
        <template id="evaluacion_responder_form_start" name="Evaluacion: comenzar">
            <div class="wrap o_survey_start">
                <div class='mb32'>
                    <button onclick="handleResponseClima()" value="start" class="btn btn-primary btn-lg">
                        Enviar
                    </button>
                </div>
            </div>
        </template>

    <!-- Finished (taken and finished) survey page -->
    <template id="evaluacion_responder_form_done" name="Evaluaciones: Terminada">
        <div class="wrap">
            <div class="o_survey_finished mt32 mb32">
                <h1>Gracias!</h1>
                <div class="row">
                    <div class="col">
                        <div class="o_survey_review">
                            Has completado la evaluacion. Puedes revisar tus respuestas.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Question widgets -->
    <template id="preguntas_contenedor" name="Evaluaciones: contenedor de  preguntas">
        <t t-set="default_constr_error_msg">This question requires an answer.</t>
        <t t-set="default_validation_error_msg">The answer you entered is not valid.</t>
        <t t-set="default_comments_message">If other, please specify:</t>
        <div t-attf-class="js_question-wrapper pb-4">
            <t t-set="numero_pregunta" t-value="0"/>
            <t t-foreach="pregunta" t-as="p">
                <t t-set="numero_pregunta" t-value="numero_pregunta + 1"/>
                <div class="col mb-5">
                    <div class="o_survey_question_title mb-3">
                        <span t-esc="str(numero_pregunta) + '.- '" class="o_survey_question_number"/>
                        <span t-field="p.pregunta_texto"/>
                    </div>
                    <t t-if="p.tipo == 'open_question'" t-call="evaluaciones.question_text_box">
                        <t t-set="question" t-value="p"/>
                    </t>
                    <t t-if="p.tipo == 'multiple_choice'" t-call="evaluaciones.question_matrix">
                        <t t-set="question" t-value="p"/>
                    </t>
                </div>
            </t>

            <t t-call="evaluaciones.evaluacion_responder_form_start"/>

        </div>
    </template>

    <!-- Open question -->
    <template id="question_text_box" name="Preguntas: pregunta abierta">
        <div class="o_survey_comment_container p-0">
            <textarea class="form-control o_survey_question_text_box bg-transparent text-dark rounded-0 p-0" rows="3"
                    t-att-name="'question_' + str(question.id)" 
                    t-att-placeholder="'Responde aqui...'"
                    t-att-data-question-type="question.tipo"></textarea>
        </div>
    </template>

    <!-- Simple choice question -->
    <template id="question_simple_choice" name="Question: simple choice">
        <div class="row g-2 o_survey_answer_wrapper o_survey_form_choice"
            t-att-data-name="question.id"
            data-question-type="simple_choice_radio">
            <t t-set="item_idx" t-value="0"/>
            <t t-foreach='question.opcion_ids' t-as='label'>
                <t t-set="item_idx" t-value="label_index"/>

                <div t-attf-class="col-sm-12 #{use_half_col_lg}">
                    <label t-att-for="str(question.id) + '_' + str(label.id)"
                        t-attf-class="o_survey_choice_btn py-1 px-3 w-100 h-100 rounded #{answer_class} #{'o_survey_selected' if answer_selected else ''}">
                        <t t-call="evaluaciones.survey_selection_key">
                            <t t-set="selection_key_class" t-value="'position-relative o_survey_radio_btn float-start d-flex'"/>
                        </t>
                        <!-- <i class="fa fa-check-circle float-end mt-1 ms-1 position-relative"/>
                        <i class="fa fa-circle-thin float-end mt-1 ms-1 position-relative"/> -->
                        <input t-att-id="str(question.id) + '_' + str(label.id)" type="radio" t-att-value='label.id'
                            t-attf-class="o_survey_form_choice_item position-absolute #{'o_survey_form_choice_item_selected' if answer_selected else ''}"
                            t-att-name='question.id'
                            t-att-data-selection-key="letters[item_idx] if useKeySelection else ''"/>
                        <span class="ms-2 text-break" t-field='label.opcion_texto'/>
                    </label>
                </div>
            </t>
        </div>
    </template>

    <!-- Matrix question -->
    <template id="question_matrix" name="Question: matrix">
        <table class="table table-borderless o_survey_question_matrix text-white text-center mb-0"
               t-att-data-name="question.id"
               t-att-data-question-type="question.tipo"
               t-att-data-sub-questions="question.pregunta_texto">
            <thead>
                <tr>
                    <th class="fw-normal" t-foreach="question.opcion_ids" t-as="col_label"><span t-field="col_label.opcion_texto" /></th>
                </tr>
            </thead>
            <tbody>
                <!-- For matrix, we have an extra check because we have rows * columns total options -->
                <tr class="bg-white text-white" t-foreach="question" t-as="row_label" t-att-id="row_label">
                    <t t-foreach="question.opcion_ids" t-as="col_label">
                        <td t-att-class="'o_survey_matrix_btn text-primary position-relative %s'% ('o_survey_selected' if answer else '')">
                            <input t-att-type="'radio'"
                                t-att-name="'%s_%s' % (question.id, row_label.id)" 
                                t-att-value="col_label.opcion_texto"
                                t-att-data-row-id="row_label.id"
                                t-att-data-col-id="col_label"
                                class="o_survey_form_choice_item"/>
                        </td>
                    </t>
                </tr>
            </tbody>
        </table>
    </template>
</data>
</odoo>
