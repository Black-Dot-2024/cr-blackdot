<?xml version="1.0" encoding="utf-8"?>
<odoo>
<data>
    <!-- diseño copiado de las encuestas de odoo -->
    <template id="evaluaciones.diseño" name="Diseño de responder a evaluacion clima" inherit_id="web.frontend_layout" primary="True">
        <xpath expr="//div[@id='wrapwrap']" position="before">
            <t t-set="no_livechat" t-value="True"/>
        </xpath>
        <xpath expr="//div[@id='wrapwrap']" position="attributes">
                <attribute name="t-attf-class" add="o_survey_background" separator=" "/>
        </xpath>
        <xpath expr="//head/t[@t-call-assets][last()]" position="after">
            <t t-call-assets="evaluaciones.evaluaciones_assets" lazy_load="True"/>
        </xpath>
        <xpath expr="//header" position="before">
            <t t-set="no_header" t-value="True"/>
            <t t-set="no_footer" t-value="True"/>
        </xpath>
        <xpath expr="//header" position="after">
            <div id="wrap" class="oe_structure oe_empty"/>
        </xpath>
    </template>

    <!-- Main survey template -->
    <template id="evaluaciones_responder" name="Evaluaciones: responder evaluacion clima">
        <t t-call="evaluaciones.diseño">
            <div class="wrap o_survey_wrap d-flex">
                <div class="container o_survey_form d-flex flex-column mb-5">
                    <t t-call="evaluaciones.evaluacion_header" />
                    <t t-call="evaluaciones.evaluacion_responder_form" />
                </div>
            </div>
        </t>
    </template>

    <template id="evaluacion_header" name="Evaluacion: Encabezado pagina principal">
        <div class="o_survey_nav pt16 mb-2">
            <div class="container m-0 p-0">
                <div class="row">
                    <div  class="col-lg-10">
                        <h1 class="o_survey_main_title pt-4">
                            <span t-field="evaluacion.nombre" />
                        </h1>
                    </div>
                </div>
                <div class="row">
                    <div  class="col-lg-10">
                        <div t-field='evaluacion.descripcion' class="oe_no_empty pb-5 text-break"/>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="evaluacion_responder_form" name="Evaluaciones: contenido principal">
        <form role="form" method="post" t-att-name="evaluacion.id" class="d-flex flex-grow-1 align-items-center">
            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
            <input type="hidden" name="evaluacion_id" t-att-value="evaluacion.id"/>
            <input type="hidden" name="token" t-att-value="token"/>
            <div class="o_survey_error alert alert-danger d-none" role="alert">
                <p>Hubo un error al momento de validar las evaluaciones.</p>
            </div>

            <div class="o_survey_form_content w-100">

                <t t-if="contestada == 'contestada'"  t-call="evaluaciones.evaluacion_responder_form_done"/>
                <t t-elif="evaluacion.estado == 'finalizado'" t-call="evaluaciones.evaluacion_responder_form_closed"/>
                <t t-elif="evaluacion.estado == 'publicado'" t-call="evaluaciones.preguntas_contenedor"/>
                <t t-elif="evaluacion.estado == 'borrador'" t-call="evaluaciones.evaluacion_responder_form_draft"/>

            </div>
        </form>

        <!-- Modal used to display error message, i.c.o. ajax error -->
        <div role="dialog" class="modal fade" id="MasterTabErrorModal" >
            <div class="modal-dialog">
                <div class="modal-content">
                    <header class="modal-header">
                        <h4 class="modal-title">Ha ocurrido un problema</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </header>
                    <main class="modal-body"><p>Para tomar esta evaluacion cierra las demas ventanas<strong class="text-danger"></strong>.</p></main>
                    <footer class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Continua aqui</button></footer>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Start (not taken) survey page -->
        <template id="evaluacion_responder_form_start" name="Evaluacion: comenzar">
            <div class="wrap o_survey_start">
                <div class='mb32'>
                    <button onclick="return confirmacion()" value="start" class="btn btn-primary btn-lg">
                        Enviar
                    </button>

                    <script>
                        function confirmacion() {
                            if (confirm("¿Estas seguro de enviar tus respuestas?")) {
                                handleResponseClima();
                                return true;
                            } else {
                                return false;
                            }
                        }
                    </script>
                </div>
            </div>
        </template>

    <!-- Finished (taken and finished) survey page -->
    <template id="evaluacion_responder_form_done" name="Evaluaciones: Terminada">
        <div class="wrap">
            <div class="o_survey_finished mt32 mb32">
                <h1>Gracias!</h1>
                <div class="row">
                    <div class="col">
                        <div class="o_survey_review">
                            Has completado la evaluacion. Puedes revisar tus respuestas.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Closed survey page -->
    <template id="evaluacion_responder_form_closed" name="Evaluaciones: Cerrada">
        <div class="wrap">
            <div class="o_survey_finished mt32 mb32">
                <h1>Gracias!</h1>
                <div class="row">
                    <div class="col">
                        <div class="o_survey_review">
                            Se ha terminado el plazo para contestar esta evaluacion.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>


    <!-- Draft survey page -->
    <template id="evaluacion_responder_form_draft" name="Evaluaciones: No se encuentra">
        <div class="wrap">
            <div class="o_survey_finished mt32 mb32">
                <h1>404</h1>
                <div class="row">
                    <div class="col">
                        <div class="o_survey_review">
                            Pagina no encontrada
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>


    <!-- Question widgets -->
    <template id="preguntas_contenedor" name="Evaluaciones: contenedor de  preguntas">
        <t t-set="default_constr_error_msg">This question requires an answer.</t>
        <t t-set="default_validation_error_msg">The answer you entered is not valid.</t>
        <t t-set="default_comments_message">If other, please specify:</t>
        <div t-attf-class="js_question-wrapper pb-4">
            <t t-set="numero_pregunta" t-value="0"/>
            <t t-foreach="pregunta" t-as="p">
                <t t-set="numero_pregunta" t-value="numero_pregunta + 1"/>
                <div class="col mb-5">
                    <div class="o_survey_question_title mb-3">
                        <span t-esc="str(numero_pregunta) + '.- '" class="o_survey_question_number"/>
                        <span t-field="p.pregunta_texto"/>
                    </div>
                    <t t-if="p.tipo == 'multiple_choice' and p.condicional" t-call="evaluaciones.conditional_question">
                        <t t-set="question" t-value="p"/>
                    </t>
                    <t t-if="p.tipo == 'open_question'" t-call="evaluaciones.question_text_box">
                        <t t-set="question" t-value="p"/>
                    </t>
                    <t t-if="p.tipo == 'multiple_choice'" t-call="evaluaciones.question_matrix">
                        <t t-set="question" t-value="p"/>
                    </t>
                    <t t-if="p.tipo == 'escala'" t-call="evaluaciones.question_scale">
                        <t t-set="question" t-value="p"/>
                    </t>
                </div>
            </t>

            <t t-call="evaluaciones.evaluacion_responder_form_start"/>

        </div>
    </template>

    <!-- Open question -->
    <template id="question_text_box" name="Preguntas: pregunta abierta">
        <div class="o_survey_comment_container p-0">
            <textarea class="form-control o_survey_question_text_box bg-transparent text-dark rounded-0 p-0" rows="3"
                    t-att-name="'question_' + str(question.id)" 
                    t-att-placeholder="'Responde aqui...'"
                    t-att-data-question-type="question.tipo"
                    required="required"></textarea>
        </div>
    </template>

    <!-- Matrix question -->
    <template id="question_matrix" name="Pregunta: Opcion multiple">
        <table class="table table-borderless o_survey_question_matrix text-white text-center mb-0"
               t-att-data-name="question.id"
               t-att-data-question-type="question.tipo"
               t-att-data-sub-questions="question.pregunta_texto">
            <thead>
                <tr>
                    <th class="fw-normal" t-foreach="question.opcion_ids" t-as="col_label"><span t-field="col_label.opcion_texto" /></th>
                </tr>
            </thead>
            <tbody>
                <!-- For matrix, we have an extra check because we have rows * columns total options -->
                <tr class="bg-white text-white" t-foreach="question" t-as="row_label" t-att-id="row_label">
                    <t t-foreach="question.opcion_ids" t-as="col_label">
                        <td t-att-class="'o_survey_matrix_btn text-primary position-relative %s'% ('o_survey_selected' if answer else '')">
                            <input t-att-type="'radio'"
                                t-att-name="'%s_%s' % (question.id, row_label.id)" 
                                t-att-value="col_label.id"
                                t-att-data-row-id="row_label.id"
                                t-att-data-col-id="col_label"
                                class="o_survey_form_choice_item"
                                required="required"/>
                        </td>
                    </t>
                </tr>
            </tbody>
        </table>
    </template>

    <!-- Scale question -->
    <template id="question_scale" name="Pregunta: escala">
        <t t-set="opciones" t-value="['Nunca', 'Casi nunca', 'A veces', 'Casi siempre', 'Siempre']"/>
        <t t-set="desc" t-value="[5, 4, 3, 2, 1]"/>
        <t t-set="asc" t-value="[1, 2, 3, 4, 5]"/>
        <table class="table table-borderless o_survey_question_matrix text-white text-center mb-0"
               t-att-data-name="question.id"
               t-att-data-question-type="question.tipo"
               t-att-data-sub-questions="question.pregunta_texto">
            <thead>
                <tr>
                    <th class="fw-normal" t-foreach="opciones" t-as="col_label"><span t-esc="col_label" /></th>
                </tr>
            </thead>
            <tbody>
                <!-- For matrix, we have an extra check because we have rows * columns total options -->
                <tr class="bg-white text-white" t-foreach="question" t-as="row_label" t-att-id="row_label">
                    <!-- iterador -->
                    <t t-set="iterador" t-value="0"/>
                    <t t-foreach="opciones" t-as="col_label">
                        <td t-att-class="'o_survey_matrix_btn text-primary position-relative %s'% ('o_survey_selected' if answer else '')">
                            <t t-if="row_label.ponderacion == 'descendente'">
                                <input t-att-type="'radio'"
                                    t-att-name="'%s_%s' % (question.id, row_label.id)" 
                                    t-att-value="desc[iterador]"
                                    t-att-data-row-id="row_label.id"
                                    t-att-data-col-id="col_label"
                                    class="o_survey_form_choice_item"
                                    required="required"/>
                            </t>
                            <t t-else="">
                                <input t-att-type="'radio'"
                                    t-att-name="'%s_%s' % (question.id, row_label.id)" 
                                    t-att-value="asc[iterador]"
                                    t-att-data-row-id="row_label.id"
                                    t-att-data-col-id="col_label"
                                    class="o_survey_form_choice_item"
                                    required="required"/>
                            </t>
                        </td>
                    </t>
                </tr>
            </tbody>
        </table>
    </template>

    <!-- conditional question -->
    <template id="conditional_question" name="Pregunta: pregunta condicional">
        <table class="table table-borderless o_survey_question_matrix text-white text-center mb-0"
               t-att-data-name="question.id"
               t-att-data-question-type="question.tipo"
               t-att-data-sub-questions="question.pregunta_texto">
            <thead>
                <tr>
                    <th class="fw-normal" t-foreach="question.opcion_ids" t-as="col_label"><span t-field="col_label.opcion_texto" /></th>
                </tr>
            </thead>
            <tbody>
                <!-- For matrix, we have an extra check because we have rows * columns total options -->
                <tr class="bg-white text-white" t-foreach="question" t-as="row_label" t-att-id="row_label">
                    <t t-foreach="question.opcion_ids" t-as="col_label">
                        <td t-att-class="'o_survey_matrix_btn text-primary position-relative %s'% ('o_survey_selected' if answer else '')">
                            <input t-att-type="'radio'"
                                t-att-name="'%s_%s' % (question.id, row_label.id)" 
                                t-att-value="col_label.id"
                                t-att-data-row-id="row_label.id"
                                t-att-data-col-id="col_label"
                                class="o_survey_form_choice_item"
                                required="required"/>
                        </td>
                    </t>
                </tr>
            </tbody>
        </table>
    </template>
</data>
</odoo>
